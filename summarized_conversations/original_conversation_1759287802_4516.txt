{'role': 'assistant', 'content': 'Now let me create a comprehensive documentation file for the pricing system:\n\n<function_calls>\n<create-file file_path="medical-analysis-platform/docs/PRICING_SYSTEM.md">\n# HoloVitals Pricing & Token System Documentation\n\n## Overview\n\nThe HoloVitals pricing system is a comprehensive token-based subscription model that allows users to process medical documents efficiently while maintaining cost transparency and flexibility.\n\n## Table of Contents\n\n1. [Subscription Tiers](#subscription-tiers)\n2. [Token System](#token-system)\n3. [File Upload & Processing](#file-upload--processing)\n4. [Cost Estimation](#cost-estimation)\n5. [Multi-Month Processing](#multi-month-processing)\n6. [API Reference](#api-reference)\n7. [Service Architecture](#service-architecture)\n\n---\n\n## Subscription Tiers\n\n### Basic Tier - $9.99/month\n- **Monthly Tokens**: 100,000 tokens\n- **Free Upload Limit**: 10MB (first upload only)\n- **Max File Size**: 100MB\n- **Priority**: Standard (Level 1)\n- **Support**: Email support\n- **Features**:\n  - Basic AI chat support\n  - Document analysis\n  - OCR processing\n  - Standard processing speed\n\n### Professional Tier - $29.99/month\n- **Monthly Tokens**: 500,000 tokens\n- **Free Upload Limit**: 25MB (first upload only)\n- **Max File Size**: 500MB\n- **Priority**: High (Level 3)\n- **Support**: Priority email support\n- **Features**:\n  - Advanced AI analysis\n  - Priority processing\n  - Batch document processing\n  - Faster processing speed\n  - All Basic features\n\n### Enterprise Tier - $99.99/month\n- **Monthly Tokens**: 2,000,000 tokens\n- **Free Upload Limit**: 100MB (first upload only)\n- **Max File Size**: 1GB\n- **Priority**: Highest (Level 5)\n- **Support**: Dedicated support\n- **Features**:\n  - Premium AI models (GPT-4, Claude 3.5)\n  - Highest priority processing\n  - Unlimited batch processing\n  - Advanced analytics\n  - Custom integrations\n  - Fastest processing speed\n  - All Professional features\n\n### Annual Subscriptions\n- **20% discount** on all tiers when billed annually\n- Basic: $95.90/year (save $23.98)\n- Professional: $287.90/year (save $71.98)\n- Enterprise: $959.90/year (save $239.98)\n\n---\n\n## Token System\n\n### What are Tokens?\n\nTokens are the currency used to process documents and perform AI operations on HoloVitals. Different operations consume different amounts of tokens based on complexity.\n\n### Token Costs\n\n| Operation | Tokens Required |\n|-----------|----------------|\n| Document Processing (per MB) | 1,000 tokens |\n| Chat Message (average) | 500 tokens |\n| Full Document Analysis | 5,000 tokens |\n| Context Optimization | 100 tokens |\n| Batch Processing Job | 10,000 tokens |\n\n### Token Packages (One-Time Purchases)\n\n| Package | Base Tokens | Bonus Tokens | Total | Price |\n|---------|-------------|--------------|-------|-------|\n| Starter | 50,000 | 0 | 50,000 | $4.99 |\n| Standard | 100,000 | 5,000 | 105,000 | $9.99 |\n| Plus | 250,000 | 25,000 | 275,000 | $24.99 |\n| Pro | 500,000 | 75,000 | 575,000 | $49.99 |\n| Enterprise | 1,000,000 | 200,000 | 1,200,000 | $99.99 |\n\n### Token Balance Management\n\n- **Monthly Refresh**: Tokens are automatically added on your billing cycle date\n- **Rollover**: Unused tokens roll over to the next month (no expiration)\n- **Purchases**: One-time token purchases are added immediately\n- **Deductions**: Tokens are deducted when operations complete\n- **Refunds**: Failed operations result in automatic token refunds\n\n---\n\n## File Upload & Processing\n\n### Free Upload Limits\n\nEach tier includes a **one-time free upload limit** for your first upload:\n- **Basic**: First 10MB is free (no tokens charged)\n- **Professional**: First 25MB is free (no tokens charged)\n- **Enterprise**: First 100MB is free (no tokens charged)\n\n**Important**: The free upload limit applies only to your **first upload** and only up to the specified size. Subsequent uploads or portions exceeding the limit will consume tokens.\n\n### File Size Limits\n\n| Tier | Maximum File Size |\n|------|------------------|\n| Basic | 100MB |\n| Professional | 500MB |\n| Enterprise | 1GB (1,024MB) |\n\n### Supported File Types\n\n- **PDF Documents**: Most efficient, ~1,000 tokens per MB\n- **Images (JPEG, PNG)**: Requires OCR, ~1,000-1,500 tokens per MB\n- **Text Files**: Most efficient, ~800 tokens per MB\n- **Other Formats**: ~1,000-1,500 tokens per MB\n\n### Processing Options\n\nWhen uploading a file, you have several processing options:\n\n#### 1. Immediate Processing\n- **Requirements**: Sufficient token balance\n- **Processing Time**: Starts immediately\n- **Best For**: Urgent documents, sufficient balance\n\n#### 2. One-Time Token Purchase\n- **Requirements**: Purchase additional tokens\n- **Processing Time**: Starts after payment\n- **Best For**: One-time large uploads\n\n#### 3. Multi-Month Processing\n- **Requirements**: Active subscription\n- **Processing Time**: Spread over multiple months\n- **Best For**: Large files, limited budget\n- **Details**: File is processed in chunks as monthly tokens refresh\n\n#### 4. Tier Upgrade\n- **Requirements**: Upgrade to higher tier\n- **Processing Time**: Starts after upgrade\n- **Best For**: Regular large file processing needs\n\n---\n\n## Cost Estimation\n\n### How Cost Estimation Works\n\nBefore processing any file, HoloVitals provides a detailed cost estimation:\n\n1. **File Analysis**: System analyzes file size, type, and content\n2. **Token Calculation**: Estimates tokens needed based on:\n   - File size (MB)\n   - File type (PDF, image, text)\n   - OCR requirements\n   - Analysis depth\n3. **Cost Breakdown**: Shows:\n   - Estimated tokens\n   - Estimated USD cost\n   - Current balance\n   - Balance after processing\n   - Free upload eligibility\n   - Processing time estimate\n\n### Example Cost Estimations\n\n#### Example 1: Basic Tier - 5MB PDF (First Upload)\n```\nFile Size: 5MB\nFile Type: PDF\nEstimated Tokens: 0 (uses free upload limit)\nEstimated Cost: $0.00\nFree Upload Used: 5MB of 10MB\nBalance After: 100,000 tokens (unchanged)\nProcessing Time: ~1 minute\nRecommendation: Free upload - no tokens charged\n```\n\n#### Example 2: Basic Tier - 50MB PDF\n```\nFile Size: 50MB\nFile Type: PDF\nEstimated Tokens: 50,000 tokens\nEstimated Cost: $5.00\nCurrent Balance: 100,000 tokens\nBalance After: 50,000 tokens\nProcessing Time: ~5 minutes\nRecommendation: Sufficient balance for immediate processing\n```\n\n#### Example 3: Basic Tier - 500MB PDF (Exceeds Limit)\n```\nFile Size: 500MB\nFile Type: PDF\nError: File size exceeds tier limit (100MB)\nRecommendation: Upgrade to Professional tier or split file\n```\n\n#### Example 4: Professional Tier - 200MB PDF (Insufficient Balance)\n```\nFile Size: 200MB\nFile Type: PDF\nEstimated Tokens: 200,000 tokens\nEstimated Cost: $20.00\nCurrent Balance: 50,000 tokens\nTokens Needed: 150,000 more\nProcessing Options:\n1. Purchase 250K token package ($24.99)\n2. Multi-month processing (4 months)\n3. Upgrade to Enterprise tier\n```\n\n---\n\n## Multi-Month Processing\n\n### Overview\n\nMulti-month processing allows users to process large files over multiple billing cycles, using their monthly token allocation.\n\n### How It Works\n\n1. **Upload File**: Upload file and receive cost estimation\n2. **Choose Multi-Month**: Select multi-month processing option\n3. **Schedule Created**: System calculates processing schedule\n4. **Monthly Processing**: File is processed in chunks each month\n5. **Automatic Deduction**: Tokens deducted as each chunk completes\n\n### Example Multi-Month Schedule\n\n**Scenario**: Professional tier user with 200MB file requiring 200,000 tokens\n\n```\nCurrent Balance: 50,000 tokens\nMonthly Allocation: 500,000 tokens\nTotal Tokens Needed: 200,000 tokens\n\nProcessing Schedule:\nMonth 1: 50,000 tokens (25% complete) - Uses current balance\nMonth 2: 150,000 tokens (100% complete) - Uses monthly refresh\n\nEstimated Completion: 2 months\n```\n\n### Benefits\n\n- **No upfront cost**: Use existing subscription\n- **Flexible**: Process large files without immediate payment\n- **Automatic**: System handles scheduling and processing\n- **Transparent**: Track progress monthly\n\n### Limitations\n\n- **Maximum Duration**: 12 months\n- **Active Subscription Required**: Must maintain active subscription\n- **No Cancellation Refund**: Tokens already used are not refunded\n\n---\n\n## API Reference\n\n### Subscription Endpoints\n\n#### Create/Upgrade Subscription\n```http\nPOST /api/subscriptions\nContent-Type: application/json\n\n{\n  "userId": "user-id",\n  "tier": "PROFESSIONAL",\n  "paymentMethodId": "pm_xxx",\n  "trialPeriod": false,\n  "action": "upgrade",\n  "immediate": true\n}\n\nResponse:\n{\n  "success": true,\n  "subscription": { ... },\n  "message": "Subscription upgraded to PROFESSIONAL immediately"\n}\n```\n\n#### Get Current Subscription\n```http\nGET /api/subscriptions?userId=user-id\n\nResponse:\n{\n  "success": true,\n  "subscription": {\n    "id": "sub-id",\n    "tier": "PROFESSIONAL",\n    "status": "ACTIVE",\n    "monthlyPrice": 29.99,\n    "billingCycleStart": "2025-01-01",\n    "billingCycleEnd": "2025-02-01",\n    "tokenBalance": { ... },\n    "tierConfig": { ... }\n  }\n}\n```\n\n#### Cancel Subscription\n```http\nPOST /api/subscriptions/cancel\nContent-Type: application/json\n\n{\n  "userId": "user-id",\n  "reason": "No longer needed",\n  "immediate": false\n}\n\nResponse:\n{\n  "success": true,\n  "subscription": { ... },\n  "message": "Subscription will be cancelled at the end of the billing cycle"\n}\n```\n\n### Token Endpoints\n\n#### Get Token Balance\n```http\nGET /api/tokens/balance?userId=user-id\n\nResponse:\n{\n  "success": true,\n  "balance": {\n    "currentBalance": 450000,\n    "currentBalanceFormatted": "450K",\n    "totalEarned": 500000,\n    "totalUsed": 50000,\n    "totalPurchased": 0,\n    "monthlyAllocation": 500000,\n    "freeUploadRemaining": 25000000\n  }\n}\n```\n\n#### Purchase Tokens\n```http\nPOST /api/tokens/purchase\nContent-Type: application/json\n\n{\n  "userId": "user-id",\n  "packageIndex": 2,\n  "paymentIntentId": "pi_xxx"\n}\n\nResponse:\n{\n  "success": true,\n  "balance": { ... },\n  "package": {\n    "tokens": 250000,\n    "bonus": 25000,\n    "price": 24.99,\n    "displayName": "250K Tokens + 25K Bonus"\n  },\n  "message": "Successfully purchased 250K Tokens + 25K Bonus"\n}\n```\n\n#### Get Transaction History\n```http\nGET /api/tokens/history?userId=user-id&limit=50&offset=0\n\nResponse:\n{\n  "success": true,\n  "transactions": [ ... ],\n  "total": 150,\n  "limit": 50,\n  "offset": 0,\n  "hasMore": true\n}\n```\n\n#### Get Usage Analytics\n```http\nGET /api/tokens/analytics?userId=user-id&days=30\n\nResponse:\n{\n  "success": true,\n  "analytics": {\n    "period": { ... },\n    "usage": {\n      "total": 150000,\n      "averageDaily": 5000,\n      "projectedMonthly": 150000\n    },\n    "dailyUsage": [ ... ],\n    "usageByType": [ ... ]\n  }\n}\n```\n\n### Upload Endpoints\n\n#### Estimate Upload Cost\n```http\nPOST /api/uploads/estimate\nContent-Type: application/json\n\n{\n  "userId": "user-id",\n  "fileName": "medical-records.pdf",\n  "filePath": "/uploads/medical-records.pdf",\n  "fileSize": 52428800,\n  "mimeType": "application/pdf",\n  "requiresOCR": true,\n  "requiresAnalysis": true\n}\n\nResponse:\n{\n  "success": true,\n  "upload": { ... },\n  "costEstimation": {\n    "fileSize": 52428800,\n    "fileSizeFormatted": "50.00 MB",\n    "estimatedTokens": 50000,\n    "estimatedCost": 5.00,\n    "canAfford": true,\n    "useFreeUpload": false,\n    "recommendation": "You have sufficient tokens..."\n  },\n  "tierConfig": { ... }\n}\n```\n\n#### Approve Upload\n```http\nPOST /api/uploads/approve\nContent-Type: application/json\n\n{\n  "uploadId": "upload-id",\n  "approved": true,\n  "processingOption": "immediate"\n}\n\nResponse:\n{\n  "success": true,\n  "status": "approved",\n  "message": "File queued for immediate processing",\n  "upload": { ... }\n}\n```\n\n#### Get Upload History\n```http\nGET /api/uploads?userId=user-id&limit=50&offset=0\n\nResponse:\n{\n  "success": true,\n  "uploads": [ ... ],\n  "total": 25,\n  "limit": 50,\n  "offset": 0,\n  "hasMore": false\n}\n```\n\n#### Cancel Upload\n```http\nDELETE /api/uploads?uploadId=upload-id&reason=Changed%20mind\n\nResponse:\n{\n  "success": true,\n  "status": "cancelled",\n  "message": "Upload cancelled successfully"\n}\n```\n\n### Pricing Endpoint\n\n#### Get Pricing Information\n```http\nGET /api/pricing\n\nResponse:\n{\n  "success": true,\n  "tiers": [ ... ],\n  "tokenPackages": [ ... ],\n  "tokenCosts": { ... },\n  "pricingRules": { ... }\n}\n```\n\n---\n\n## Service Architecture\n\n### Core Services\n\n#### 1. PricingService\n- Cost estimation for file uploads\n- Multi-month processing calculations\n- Tier upgrade recommendations\n- Token usage statistics\n\n#### 2. SubscriptionService\n- Subscription creation and management\n- Tier upgrades/downgrades\n- Monthly token refresh\n- Subscription lifecycle management\n\n#### 3. TokenService\n- Token balance tracking\n- Token deductions and refunds\n- Token purchases\n- Transaction history\n- Usage analytics\n\n#### 4. FileUploadService\n- File upload management\n- Cost approval workflow\n- Multi-month processing scheduler\n- Upload status tracking\n\n### Database Schema\n\n#### Subscription Table\n```sql\n- id (UUID)\n- userId (UUID, unique)\n- tier (BASIC | PROFESSIONAL | ENTERPRISE)\n- status (ACTIVE | PAST_DUE | CANCELLED | EXPIRED | TRIAL)\n- monthlyPrice (Float)\n- billingCycleStart (DateTime)\n- billingCycleEnd (DateTime)\n- nextBillingDate (DateTime)\n- cancelledAt (DateTime, nullable)\n- trialEndsAt (DateTime, nullable)\n- metadata (JSON)\n```\n\n#### TokenBalance Table\n```sql\n- id (UUID)\n- userId (UUID, unique)\n- subscriptionId (UUID, unique)\n- currentBalance (Int)\n- totalEarned (Int)\n- totalUsed (Int)\n- totalPurchased (Int)\n- freeUploadUsed (Int)\n- lastRefreshDate (DateTime)\n```\n\n#### TokenTransaction Table\n```sql\n- id (UUID)\n- tokenBalanceId (UUID)\n- type (INITIAL_DEPOSIT | MONTHLY_REFRESH | PURCHASE | DEDUCTION | REFUND | BONUS | ADJUSTMENT)\n- amount (Int)\n- balanceBefore (Int)\n- balanceAfter (Int)\n- description (Text)\n- referenceId (String, nullable)\n- referenceType (String, nullable)\n- metadata (JSON)\n- createdAt (DateTime)\n```\n\n#### FileUpload Table\n```sql\n- id (UUID)\n- userId (UUID)\n- fileName (String)\n- filePath (String)\n- fileSize (Int)\n- mimeType (String)\n- status (PENDING | APPROVED | PROCESSING | COMPLETED | FAILED | CANCELLED | SCHEDULED)\n- estimatedTokens (Int)\n- estimatedCost (Float)\n- actualTokens (Int)\n- actualCost (Float)\n- processingStartedAt (DateTime)\n- processingCompletedAt (DateTime)\n- scheduledMonths (Int)\n- currentMonth (Int)\n- errorMessage (Text)\n- usedFreeUpload (Boolean)\n- metadata (JSON)\n```\n\n---\n\n## Best Practices\n\n### For Users\n\n1. **Use Free Upload Wisely**: Your first upload up to the tier limit is free\n2. **Monitor Token Usage**: Check analytics regularly to understand usage patterns\n3. **Plan Large Uploads**: Use cost estimation before uploading large files\n4. **Consider Multi-Month**: For large files, multi-month processing avoids upfront costs\n5. **Upgrade When Needed**: If consistently running low on tokens, consider upgrading\n\n### For Developers\n\n1. **Always Estimate First**: Call `/api/uploads/estimate` before processing\n2. **Handle Errors Gracefully**: Provide clear error messages for insufficient balance\n3. **Track Token Usage**: Log all token deductions for audit purposes\n4. **Implement Retry Logic**: Handle transient failures with exponential backoff\n5. **Monitor Performance**: Track processing times and optimize as needed\n\n---\n\n## Troubleshooting\n\n### Common Issues\n\n#### "Insufficient token balance"\n- **Solution**: Purchase additional tokens or wait for monthly refresh\n- **Alternative**: Use multi-month processing option\n\n#### "File size exceeds tier limit"\n- **Solution**: Upgrade to higher tier or split file into smaller parts\n- **Alternative**: Process file in multiple uploads\n\n#### "Free upload limit exceeded"\n- **Explanation**: Free upload limit applies only to first upload\n- **Solution**: Use tokens for subsequent uploads or purchase token package\n\n#### "Subscription expired"\n- **Solution**: Renew subscription to continue processing\n- **Grace Period**: 7 days grace period before account suspension\n\n---\n\n## Support\n\nFor additional support:\n- **Email**: support@holovitals.com\n- **Documentation**: https://docs.holovitals.com\n- **API Status**: https://status.holovitals.com\n\n---\n\n**Last Updated**: January 2025  \n**Version**: 1.0.0\n</create-file>\n</function_calls>'}