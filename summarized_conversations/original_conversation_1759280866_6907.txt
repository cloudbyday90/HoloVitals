{'role': 'assistant', 'content': '# Implementing Role-Based Access Control (RBAC) for HoloVitals\n\nI understand completely - we need to implement proper **Role-Based Access Control (RBAC)** to protect sensitive administrative and financial information. Let me create a comprehensive access control system.\n\n## Plan\n\nI\'ll implement:\n\n1. **User Roles System** - Define roles (OWNER, ADMIN, DOCTOR, PATIENT)\n2. **Permission System** - Granular permissions for each role\n3. **Middleware Protection** - API route protection\n4. **UI Access Control** - Hide/show UI elements based on role\n5. **Audit Logging** - Track all access to sensitive data\n\nLet me start by creating the access control infrastructure.\n\n<function_calls>\n<create-file file_path="lib/types/rbac.ts">\n/**\n * Role-Based Access Control (RBAC) Types\n * Defines roles, permissions, and access control for HoloVitals\n */\n\n// ============================================================================\n// USER ROLES\n// ============================================================================\n\nexport enum UserRole {\n  OWNER = \'OWNER\',           // Platform owner - full access\n  ADMIN = \'ADMIN\',           // System administrator - most access\n  DOCTOR = \'DOCTOR\',         // Medical professional - patient data access\n  PATIENT = \'PATIENT\',       // End user - own data only\n  SUPPORT = \'SUPPORT\',       // Customer support - limited access\n  ANALYST = \'ANALYST\',       // Data analyst - anonymized data only\n}\n\n// ============================================================================\n// PERMISSIONS\n// ============================================================================\n\nexport enum Permission {\n  // Financial & Cost Permissions\n  VIEW_COSTS = \'VIEW_COSTS\',\n  VIEW_FINANCIALS = \'VIEW_FINANCIALS\',\n  VIEW_REVENUE = \'VIEW_REVENUE\',\n  VIEW_EXPENSES = \'VIEW_EXPENSES\',\n  MANAGE_BILLING = \'MANAGE_BILLING\',\n  EXPORT_FINANCIAL_DATA = \'EXPORT_FINANCIAL_DATA\',\n  \n  // Administrative Permissions\n  VIEW_SYSTEM_STATS = \'VIEW_SYSTEM_STATS\',\n  VIEW_ALL_USERS = \'VIEW_ALL_USERS\',\n  MANAGE_USERS = \'MANAGE_USERS\',\n  MANAGE_ROLES = \'MANAGE_ROLES\',\n  VIEW_AUDIT_LOGS = \'VIEW_AUDIT_LOGS\',\n  MANAGE_SYSTEM_CONFIG = \'MANAGE_SYSTEM_CONFIG\',\n  \n  // Instance & Infrastructure Permissions\n  VIEW_ALL_INSTANCES = \'VIEW_ALL_INSTANCES\',\n  PROVISION_INSTANCES = \'PROVISION_INSTANCES\',\n  TERMINATE_INSTANCES = \'TERMINATE_INSTANCES\',\n  VIEW_INSTANCE_COSTS = \'VIEW_INSTANCE_COSTS\',\n  \n  // Queue & Task Permissions\n  VIEW_ALL_TASKS = \'VIEW_ALL_TASKS\',\n  MANAGE_QUEUE = \'MANAGE_QUEUE\',\n  CANCEL_ANY_TASK = \'CANCEL_ANY_TASK\',\n  \n  // Patient Data Permissions\n  VIEW_OWN_DATA = \'VIEW_OWN_DATA\',\n  VIEW_PATIENT_DATA = \'VIEW_PATIENT_DATA\',\n  MANAGE_OWN_DATA = \'MANAGE_OWN_DATA\',\n  MANAGE_PATIENT_DATA = \'MANAGE_PATIENT_DATA\',\n  \n  // Document Permissions\n  UPLOAD_DOCUMENTS = \'UPLOAD_DOCUMENTS\',\n  VIEW_OWN_DOCUMENTS = \'VIEW_OWN_DOCUMENTS\',\n  VIEW_ALL_DOCUMENTS = \'VIEW_ALL_DOCUMENTS\',\n  DELETE_OWN_DOCUMENTS = \'DELETE_OWN_DOCUMENTS\',\n  DELETE_ANY_DOCUMENTS = \'DELETE_ANY_DOCUMENTS\',\n  \n  // Chat & AI Permissions\n  USE_CHATBOT = \'USE_CHATBOT\',\n  VIEW_OWN_CONVERSATIONS = \'VIEW_OWN_CONVERSATIONS\',\n  VIEW_ALL_CONVERSATIONS = \'VIEW_ALL_CONVERSATIONS\',\n  \n  // Analytics Permissions\n  VIEW_ANONYMIZED_ANALYTICS = \'VIEW_ANONYMIZED_ANALYTICS\',\n  VIEW_DETAILED_ANALYTICS = \'VIEW_DETAILED_ANALYTICS\',\n  EXPORT_ANALYTICS = \'EXPORT_ANALYTICS\',\n}\n\n// ============================================================================\n// ROLE PERMISSIONS MAPPING\n// ============================================================================\n\nexport const ROLE_PERMISSIONS: Record<UserRole, Permission[]> = {\n  // OWNER - Full access to everything\n  [UserRole.OWNER]: [\n    // Financial\n    Permission.VIEW_COSTS,\n    Permission.VIEW_FINANCIALS,\n    Permission.VIEW_REVENUE,\n    Permission.VIEW_EXPENSES,\n    Permission.MANAGE_BILLING,\n    Permission.EXPORT_FINANCIAL_DATA,\n    \n    // Administrative\n    Permission.VIEW_SYSTEM_STATS,\n    Permission.VIEW_ALL_USERS,\n    Permission.MANAGE_USERS,\n    Permission.MANAGE_ROLES,\n    Permission.VIEW_AUDIT_LOGS,\n    Permission.MANAGE_SYSTEM_CONFIG,\n    \n    // Infrastructure\n    Permission.VIEW_ALL_INSTANCES,\n    Permission.PROVISION_INSTANCES,\n    Permission.TERMINATE_INSTANCES,\n    Permission.VIEW_INSTANCE_COSTS,\n    \n    // Queue\n    Permission.VIEW_ALL_TASKS,\n    Permission.MANAGE_QUEUE,\n    Permission.CANCEL_ANY_TASK,\n    \n    // Patient Data\n    Permission.VIEW_OWN_DATA,\n    Permission.VIEW_PATIENT_DATA,\n    Permission.MANAGE_OWN_DATA,\n    Permission.MANAGE_PATIENT_DATA,\n    \n    // Documents\n    Permission.UPLOAD_DOCUMENTS,\n    Permission.VIEW_OWN_DOCUMENTS,\n    Permission.VIEW_ALL_DOCUMENTS,\n    Permission.DELETE_OWN_DOCUMENTS,\n    Permission.DELETE_ANY_DOCUMENTS,\n    \n    // Chat\n    Permission.USE_CHATBOT,\n    Permission.VIEW_OWN_CONVERSATIONS,\n    Permission.VIEW_ALL_CONVERSATIONS,\n    \n    // Analytics\n    Permission.VIEW_ANONYMIZED_ANALYTICS,\n    Permission.VIEW_DETAILED_ANALYTICS,\n    Permission.EXPORT_ANALYTICS,\n  ],\n  \n  // ADMIN - Most access except financial details\n  [UserRole.ADMIN]: [\n    // Limited Financial (no revenue/expenses)\n    Permission.VIEW_COSTS,\n    \n    // Administrative\n    Permission.VIEW_SYSTEM_STATS,\n    Permission.VIEW_ALL_USERS,\n    Permission.MANAGE_USERS,\n    Permission.VIEW_AUDIT_LOGS,\n    Permission.MANAGE_SYSTEM_CONFIG,\n    \n    // Infrastructure\n    Permission.VIEW_ALL_INSTANCES,\n    Permission.PROVISION_INSTANCES,\n    Permission.TERMINATE_INSTANCES,\n    Permission.VIEW_INSTANCE_COSTS,\n    \n    // Queue\n    Permission.VIEW_ALL_TASKS,\n    Permission.MANAGE_QUEUE,\n    Permission.CANCEL_ANY_TASK,\n    \n    // Patient Data\n    Permission.VIEW_PATIENT_DATA,\n    Permission.MANAGE_PATIENT_DATA,\n    \n    // Documents\n    Permission.VIEW_ALL_DOCUMENTS,\n    Permission.DELETE_ANY_DOCUMENTS,\n    \n    // Chat\n    Permission.VIEW_ALL_CONVERSATIONS,\n    \n    // Analytics\n    Permission.VIEW_ANONYMIZED_ANALYTICS,\n    Permission.VIEW_DETAILED_ANALYTICS,\n  ],\n  \n  // DOCTOR - Patient care focused\n  [UserRole.DOCTOR]: [\n    // Patient Data\n    Permission.VIEW_OWN_DATA,\n    Permission.VIEW_PATIENT_DATA,\n    Permission.MANAGE_OWN_DATA,\n    \n    // Documents\n    Permission.UPLOAD_DOCUMENTS,\n    Permission.VIEW_OWN_DOCUMENTS,\n    Permission.DELETE_OWN_DOCUMENTS,\n    \n    // Chat\n    Permission.USE_CHATBOT,\n    Permission.VIEW_OWN_CONVERSATIONS,\n    \n    // Limited Infrastructure\n    Permission.PROVISION_INSTANCES,\n  ],\n  \n  // PATIENT - Own data only\n  [UserRole.PATIENT]: [\n    // Own Data Only\n    Permission.VIEW_OWN_DATA,\n    Permission.MANAGE_OWN_DATA,\n    \n    // Documents\n    Permission.UPLOAD_DOCUMENTS,\n    Permission.VIEW_OWN_DOCUMENTS,\n    Permission.DELETE_OWN_DOCUMENTS,\n    \n    // Chat\n    Permission.USE_CHATBOT,\n    Permission.VIEW_OWN_CONVERSATIONS,\n  ],\n  \n  // SUPPORT - Customer support access\n  [UserRole.SUPPORT]: [\n    // Limited User Access\n    Permission.VIEW_ALL_USERS,\n    \n    // Limited Patient Data (with consent)\n    Permission.VIEW_PATIENT_DATA,\n    \n    // Documents (view only)\n    Permission.VIEW_ALL_DOCUMENTS,\n    \n    // Chat (view only)\n    Permission.VIEW_ALL_CONVERSATIONS,\n  ],\n  \n  // ANALYST - Anonymized data only\n  [UserRole.ANALYST]: [\n    // Analytics Only\n    Permission.VIEW_ANONYMIZED_ANALYTICS,\n    Permission.EXPORT_ANALYTICS,\n    \n    // System Stats (no PII)\n    Permission.VIEW_SYSTEM_STATS,\n  ],\n};\n\n// ============================================================================\n// RESOURCE TYPES\n// ============================================================================\n\nexport enum ResourceType {\n  USER = \'USER\',\n  PATIENT = \'PATIENT\',\n  DOCUMENT = \'DOCUMENT\',\n  CONVERSATION = \'CONVERSATION\',\n  TASK = \'TASK\',\n  INSTANCE = \'INSTANCE\',\n  COST = \'COST\',\n  FINANCIAL = \'FINANCIAL\',\n  SYSTEM = \'SYSTEM\',\n}\n\n// ============================================================================\n// ACCESS CONTROL CONTEXT\n// ============================================================================\n\nexport interface AccessControlContext {\n  userId: string;\n  role: UserRole;\n  permissions: Permission[];\n  resourceType?: ResourceType;\n  resourceId?: string;\n  resourceOwnerId?: string;\n}\n\n// ============================================================================\n// ACCESS DECISION\n// ============================================================================\n\nexport interface AccessDecision {\n  allowed: boolean;\n  reason?: string;\n  requiredPermission?: Permission;\n  requiredRole?: UserRole;\n}\n\n// ============================================================================\n// AUDIT LOG ENTRY\n// ============================================================================\n\nexport interface AccessAuditLog {\n  id: string;\n  timestamp: Date;\n  userId: string;\n  userRole: UserRole;\n  action: string;\n  resourceType: ResourceType;\n  resourceId?: string;\n  permission: Permission;\n  allowed: boolean;\n  reason?: string;\n  ipAddress?: string;\n  userAgent?: string;\n}\n\n// ============================================================================\n// HELPER TYPES\n// ============================================================================\n\nexport type RoleHierarchy = {\n  [key in UserRole]: number;\n};\n\nexport const ROLE_HIERARCHY: RoleHierarchy = {\n  [UserRole.OWNER]: 100,\n  [UserRole.ADMIN]: 80,\n  [UserRole.DOCTOR]: 60,\n  [UserRole.SUPPORT]: 40,\n  [UserRole.ANALYST]: 30,\n  [UserRole.PATIENT]: 20,\n};\n\n// ============================================================================\n// PROTECTED ROUTES\n// ============================================================================\n\nexport interface ProtectedRoute {\n  path: string;\n  requiredPermissions: Permission[];\n  requiredRole?: UserRole;\n  description: string;\n}\n\nexport const PROTECTED_ROUTES: ProtectedRoute[] = [\n  // Financial Routes (OWNER only)\n  {\n    path: \'/dashboard/costs\',\n    requiredPermissions: [Permission.VIEW_COSTS],\n    requiredRole: UserRole.OWNER,\n    description: \'Cost dashboard - financial data\',\n  },\n  {\n    path: \'/api/costs/*\',\n    requiredPermissions: [Permission.VIEW_COSTS],\n    requiredRole: UserRole.OWNER,\n    description: \'Cost API endpoints\',\n  },\n  {\n    path: \'/dashboard/financials\',\n    requiredPermissions: [Permission.VIEW_FINANCIALS],\n    requiredRole: UserRole.OWNER,\n    description: \'Financial dashboard\',\n  },\n  \n  // Administrative Routes (OWNER/ADMIN)\n  {\n    path: \'/dashboard/admin\',\n    requiredPermissions: [Permission.VIEW_SYSTEM_STATS],\n    description: \'Admin dashboard\',\n  },\n  {\n    path: \'/dashboard/users\',\n    requiredPermissions: [Permission.VIEW_ALL_USERS],\n    description: \'User management\',\n  },\n  {\n    path: \'/api/admin/*\',\n    requiredPermissions: [Permission.MANAGE_SYSTEM_CONFIG],\n    description: \'Admin API endpoints\',\n  },\n  \n  // Instance Routes (OWNER/ADMIN)\n  {\n    path: \'/dashboard/instances\',\n    requiredPermissions: [Permission.VIEW_ALL_INSTANCES],\n    description: \'Instance management\',\n  },\n  {\n    path: \'/api/instances/*\',\n    requiredPermissions: [Permission.PROVISION_INSTANCES],\n    description: \'Instance API endpoints\',\n  },\n  \n  // Queue Routes (OWNER/ADMIN)\n  {\n    path: \'/dashboard/queue\',\n    requiredPermissions: [Permission.VIEW_ALL_TASKS],\n    description: \'Queue management\',\n  },\n  {\n    path: \'/api/queue/*\',\n    requiredPermissions: [Permission.MANAGE_QUEUE],\n    description: \'Queue API endpoints\',\n  },\n];\n</create-file>\n</function_calls>'}