{'role': 'assistant', 'content': 'Now let\'s create a comprehensive documentation file for the EHR integration system:\n\n<function_calls>\n<create-file file_path="medical-analysis-platform/docs/EHR_INTEGRATION.md">\n# HoloVitals EHR Integration System\n\n## Overview\n\nThe HoloVitals EHR Integration System enables patients to automatically retrieve their medical records from healthcare providers using FHIR (Fast Healthcare Interoperability Resources) APIs. This system is inspired by Fasten-OnPrem and supports SMART on FHIR authentication for secure, patient-authorized access to EHR data.\n\n---\n\n## Table of Contents\n\n1. [Architecture Overview](#architecture-overview)\n2. [Supported EHR Systems](#supported-ehr-systems)\n3. [FHIR Resources](#fhir-resources)\n4. [Authentication Flow](#authentication-flow)\n5. [Data Synchronization](#data-synchronization)\n6. [API Reference](#api-reference)\n7. [Database Schema](#database-schema)\n8. [Setup Guide](#setup-guide)\n9. [Security & Compliance](#security--compliance)\n\n---\n\n## Architecture Overview\n\n### Components\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                    HoloVitals Platform                       │\n│                                                              │\n│  ┌──────────────────────────────────────────────────────┐  │\n│  │              EHR Integration Layer                    │  │\n│  │                                                        │  │\n│  │  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │  │\n│  │  │ FHIR Client  │  │ SMART Auth   │  │ Sync Engine│ │  │\n│  │  └──────────────┘  └──────────────┘  └────────────┘ │  │\n│  │                                                        │  │\n│  │  ┌──────────────────────────────────────────────────┐ │  │\n│  │  │         EHR Connection Service                    │ │  │\n│  │  └──────────────────────────────────────────────────┘ │  │\n│  └──────────────────────────────────────────────────────┘  │\n│                                                              │\n│  ┌──────────────────────────────────────────────────────┐  │\n│  │              Database Layer                           │  │\n│  │  - EHR Connections                                    │  │\n│  │  - FHIR Resources                                     │  │\n│  │  - Sync History                                       │  │\n│  │  - Provider Configurations                            │  │\n│  └──────────────────────────────────────────────────────┘  │\n└─────────────────────────────────────────────────────────────┘\n                            │\n                            │ FHIR R4 + SMART on FHIR\n                            │\n┌─────────────────────────────────────────────────────────────┐\n│                    EHR Systems                               │\n│                                                              │\n│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │\n│  │  Epic    │  │  Cerner  │  │Allscripts│  │  Others  │   │\n│  │ MyChart  │  │  Oracle  │  │          │  │          │   │\n│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │\n└─────────────────────────────────────────────────────────────┘\n```\n\n### Key Features\n\n1. **SMART on FHIR Authentication**: Industry-standard OAuth2-based authentication\n2. **Multi-Provider Support**: Connect to Epic, Cerner, and 100+ healthcare systems\n3. **Automatic Synchronization**: Background sync with configurable frequency\n4. **Document Retrieval**: Download PDFs and clinical documents\n5. **Incremental Sync**: Only fetch new/updated data\n6. **Cost Integration**: Automatic token estimation and deduction\n7. **HIPAA Compliant**: Encrypted storage, audit logging, secure transmission\n\n---\n\n## Supported EHR Systems\n\n### Primary Providers\n\n| Provider | Status | FHIR Version | Document Support |\n|----------|--------|--------------|------------------|\n| Epic (MyChart) | ✅ Supported | R4 | ✅ Yes |\n| Cerner/Oracle Health | ✅ Supported | R4 | ✅ Yes |\n| Allscripts | ✅ Supported | R4 | ✅ Yes |\n| athenahealth | ✅ Supported | R4 | ✅ Yes |\n| eClinicalWorks | ✅ Supported | R4 | ✅ Yes |\n| NextGen | ✅ Supported | R4 | ✅ Yes |\n\n### Additional Providers\n\nThe system supports 100+ healthcare organizations through standardized FHIR R4 endpoints. Any provider that implements SMART on FHIR can be integrated.\n\n---\n\n## FHIR Resources\n\n### Supported Resource Types\n\nThe system can retrieve the following FHIR resource types:\n\n1. **Patient** - Patient demographics and identifiers\n2. **DocumentReference** - Clinical documents (PDFs, CCDAs, etc.)\n3. **Observation** - Lab results, vital signs, measurements\n4. **Condition** - Diagnoses and health conditions\n5. **MedicationRequest** - Prescriptions and medication orders\n6. **AllergyIntolerance** - Allergies and adverse reactions\n7. **Immunization** - Vaccination records\n8. **Procedure** - Surgical procedures and interventions\n9. **DiagnosticReport** - Lab reports and imaging results\n10. **CarePlan** - Treatment plans and care coordination\n\n### Document Types\n\nThe system can download and process:\n- **PDF documents** (discharge summaries, reports, letters)\n- **CCD/CCDA documents** (Continuity of Care Documents)\n- **Lab reports** (PDF or structured data)\n- **Imaging reports** (radiology, pathology)\n- **Clinical notes** (progress notes, consultation notes)\n\n---\n\n## Authentication Flow\n\n### SMART on FHIR OAuth2 Flow\n\n```\n┌──────────┐                                      ┌──────────┐\n│          │                                      │          │\n│  Patient │                                      │   EHR    │\n│          │                                      │  System  │\n└────┬─────┘                                      └────┬─────┘\n     │                                                 │\n     │  1. Initiate Connection                        │\n     ├────────────────────────────────────────────────┤\n     │                                                 │\n     │  2. Redirect to EHR Authorization              │\n     │◄────────────────────────────────────────────────┤\n     │                                                 │\n     │  3. Patient Logs In & Authorizes               │\n     ├────────────────────────────────────────────────►│\n     │                                                 │\n     │  4. Authorization Code                          │\n     │◄────────────────────────────────────────────────┤\n     │                                                 │\n     │  5. Exchange Code for Access Token             │\n     ├────────────────────────────────────────────────►│\n     │                                                 │\n     │  6. Access Token + Refresh Token               │\n     │◄────────────────────────────────────────────────┤\n     │                                                 │\n     │  7. Fetch Patient Data                         │\n     ├────────────────────────────────────────────────►│\n     │                                                 │\n     │  8. FHIR Resources                             │\n     │◄────────────────────────────────────────────────┤\n     │                                                 │\n```\n\n### Step-by-Step Process\n\n1. **Initiate Connection**\n   - User selects healthcare provider\n   - System creates connection record\n   - Generates authorization URL with PKCE\n\n2. **User Authorization**\n   - User redirected to EHR login page\n   - User authenticates with EHR credentials\n   - User authorizes HoloVitals to access their data\n\n3. **Token Exchange**\n   - EHR redirects back with authorization code\n   - System exchanges code for access token\n   - Tokens encrypted and stored securely\n\n4. **Data Retrieval**\n   - System uses access token to fetch FHIR resources\n   - Data stored in local database\n   - Documents downloaded and processed\n\n---\n\n## Data Synchronization\n\n### Sync Types\n\n1. **Full Sync**\n   - Retrieves all available data\n   - Used for initial connection\n   - Can be manually triggered\n\n2. **Incremental Sync**\n   - Only fetches new/updated resources\n   - Uses `_lastUpdated` parameter\n   - Runs automatically on schedule\n\n### Sync Process\n\n```\n1. Check Connection Status\n   ├─ Active? Continue\n   └─ Expired? Refresh token\n\n2. Create Sync History Record\n   └─ Status: QUEUED\n\n3. For Each Resource Type:\n   ├─ Query FHIR Server\n   ├─ Parse Resources\n   ├─ Save to Database\n   └─ Download Documents (if applicable)\n\n4. Update Sync History\n   ├─ Resources Created/Updated\n   ├─ Documents Downloaded\n   ├─ Tokens Used\n   └─ Status: COMPLETED\n\n5. Schedule Next Sync\n   └─ Based on sync frequency\n```\n\n### Sync Frequency\n\n- **Default**: Every 24 hours\n- **Configurable**: 1 hour to 7 days\n- **Manual**: Can be triggered anytime\n- **Smart Scheduling**: Avoids peak hours\n\n---\n\n## API Reference\n\n### Connection Management\n\n#### Initiate Connection\n\n```http\nPOST /api/ehr/connect\nContent-Type: application/json\n\n{\n  "userId": "user-123",\n  "provider": "EPIC",\n  "providerName": "Kaiser Permanente",\n  "fhirBaseUrl": "https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4",\n  "authorizationUrl": "https://fhir.epic.com/interconnect-fhir-oauth/oauth2/authorize",\n  "tokenUrl": "https://fhir.epic.com/interconnect-fhir-oauth/oauth2/token",\n  "clientId": "your-client-id",\n  "redirectUri": "https://holovitals.com/ehr/callback"\n}\n\nResponse:\n{\n  "success": true,\n  "connection": { ... },\n  "authorizationUrl": "https://fhir.epic.com/...",\n  "state": "random-state-value"\n}\n```\n\n#### Complete Authorization\n\n```http\nPOST /api/ehr/authorize\nContent-Type: application/json\n\n{\n  "connectionId": "conn-123",\n  "code": "authorization-code",\n  "state": "random-state-value",\n  "codeVerifier": "pkce-code-verifier"\n}\n\nResponse:\n{\n  "success": true,\n  "connection": {\n    "id": "conn-123",\n    "status": "ACTIVE",\n    "patientId": "patient-456",\n    "patientName": "John Doe"\n  }\n}\n```\n\n#### List Connections\n\n```http\nGET /api/ehr/connections?userId=user-123\n\nResponse:\n{\n  "success": true,\n  "connections": [\n    {\n      "id": "conn-123",\n      "provider": "EPIC",\n      "providerName": "Kaiser Permanente",\n      "status": "ACTIVE",\n      "patientName": "John Doe",\n      "lastSyncAt": "2025-01-15T10:30:00Z"\n    }\n  ],\n  "total": 1\n}\n```\n\n#### Disconnect Connection\n\n```http\nDELETE /api/ehr/connections?connectionId=conn-123\n\nResponse:\n{\n  "success": true,\n  "message": "Connection disconnected successfully"\n}\n```\n\n### Synchronization\n\n#### Start Sync\n\n```http\nPOST /api/ehr/sync\nContent-Type: application/json\n\n{\n  "connectionId": "conn-123",\n  "syncType": "incremental",\n  "downloadDocuments": true\n}\n\nResponse:\n{\n  "success": true,\n  "syncId": "sync-456",\n  "message": "Sync started successfully"\n}\n```\n\n#### Get Sync Status\n\n```http\nGET /api/ehr/sync?syncId=sync-456\n\nResponse:\n{\n  "success": true,\n  "sync": {\n    "id": "sync-456",\n    "status": "SYNCING",\n    "resourcesQueried": 150,\n    "resourcesCreated": 45,\n    "documentsDownloaded": 12,\n    "startedAt": "2025-01-15T10:30:00Z"\n  }\n}\n```\n\n#### Get Sync History\n\n```http\nGET /api/ehr/sync?connectionId=conn-123\n\nResponse:\n{\n  "success": true,\n  "history": [\n    {\n      "id": "sync-456",\n      "status": "COMPLETED",\n      "resourcesCreated": 45,\n      "duration": 120,\n      "completedAt": "2025-01-15T10:32:00Z"\n    }\n  ]\n}\n```\n\n### Resources\n\n#### Get Synced Resources\n\n```http\nGET /api/ehr/resources?connectionId=conn-123&resourceType=DocumentReference&limit=50\n\nResponse:\n{\n  "success": true,\n  "resources": [\n    {\n      "id": "res-789",\n      "resourceType": "DOCUMENT_REFERENCE",\n      "title": "Discharge Summary",\n      "date": "2025-01-10T00:00:00Z",\n      "contentType": "application/pdf",\n      "documentDownloaded": true\n    }\n  ],\n  "total": 150,\n  "hasMore": true\n}\n```\n\n---\n\n## Database Schema\n\n### EHRConnection\n\nStores connection information and OAuth tokens.\n\n```sql\nCREATE TABLE ehr_connections (\n  id UUID PRIMARY KEY,\n  user_id UUID NOT NULL,\n  provider VARCHAR NOT NULL,\n  provider_name VARCHAR NOT NULL,\n  fhir_base_url VARCHAR NOT NULL,\n  status VARCHAR NOT NULL,\n  access_token TEXT,\n  refresh_token TEXT,\n  token_expires_at TIMESTAMP,\n  patient_id VARCHAR,\n  patient_name VARCHAR,\n  auto_sync BOOLEAN DEFAULT true,\n  sync_frequency INT DEFAULT 24,\n  last_sync_at TIMESTAMP,\n  next_sync_at TIMESTAMP,\n  created_at TIMESTAMP DEFAULT NOW(),\n  updated_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n### FHIRResource\n\nStores raw FHIR resources and extracted metadata.\n\n```sql\nCREATE TABLE fhir_resources (\n  id UUID PRIMARY KEY,\n  connection_id UUID NOT NULL,\n  resource_type VARCHAR NOT NULL,\n  fhir_id VARCHAR NOT NULL,\n  raw_data TEXT NOT NULL,\n  title VARCHAR,\n  description TEXT,\n  date TIMESTAMP,\n  category VARCHAR,\n  status VARCHAR,\n  content_type VARCHAR,\n  content_url TEXT,\n  document_downloaded BOOLEAN DEFAULT false,\n  local_file_path VARCHAR,\n  processed BOOLEAN DEFAULT false,\n  created_at TIMESTAMP DEFAULT NOW(),\n  UNIQUE(connection_id, fhir_id, resource_type)\n);\n```\n\n### SyncHistory\n\nTracks synchronization operations and metrics.\n\n```sql\nCREATE TABLE sync_history (\n  id UUID PRIMARY KEY,\n  connection_id UUID NOT NULL,\n  status VARCHAR NOT NULL,\n  sync_type VARCHAR DEFAULT \'incremental\',\n  started_at TIMESTAMP,\n  completed_at TIMESTAMP,\n  duration INT,\n  resources_queried INT DEFAULT 0,\n  resources_created INT DEFAULT 0,\n  resources_updated INT DEFAULT 0,\n  documents_downloaded INT DEFAULT 0,\n  total_bytes_downloaded BIGINT DEFAULT 0,\n  tokens_estimated INT,\n  tokens_used INT,\n  error_message TEXT,\n  created_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n---\n\n## Setup Guide\n\n### Prerequisites\n\n1. **Epic Sandbox Account** (for testing)\n   - Register at: https://fhir.epic.com/\n   - Create a patient-facing app\n   - Get client ID and configure redirect URI\n\n2. **Environment Variables**\n\n```env\n# Encryption key for OAuth tokens (32 bytes)\nENCRYPTION_KEY=your-32-byte-encryption-key-here\n\n# Epic Configuration (Sandbox)\nEPIC_CLIENT_ID=your-epic-client-id\nEPIC_REDIRECT_URI=http://localhost:3000/ehr/callback\n\n# Production URLs (replace with actual)\nNEXT_PUBLIC_APP_URL=http://localhost:3000\n```\n\n### Installation\n\n1. **Install Dependencies**\n\n```bash\nnpm install fhir-kit-client simple-oauth2 axios\n```\n\n2. **Run Database Migration**\n\n```bash\nnpx prisma db push\nnpx prisma generate\n```\n\n3. **Test Connection**\n\n```bash\n# Start development server\nnpm run dev\n\n# Test Epic sandbox connection\ncurl -X POST http://localhost:3000/api/ehr/connect \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "userId": "test-user",\n    "provider": "EPIC",\n    "providerName": "Epic Sandbox",\n    "fhirBaseUrl": "https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4",\n    "authorizationUrl": "https://fhir.epic.com/interconnect-fhir-oauth/oauth2/authorize",\n    "tokenUrl": "https://fhir.epic.com/interconnect-fhir-oauth/oauth2/token",\n    "clientId": "your-client-id",\n    "redirectUri": "http://localhost:3000/ehr/callback"\n  }\'\n```\n\n### Epic Sandbox Testing\n\n1. **Test Patients Available**:\n   - Derrick Lin (Patient ID: eVgg3VZXq3V3FLezRJOQBgw3)\n   - Camila Lopez (Patient ID: erXuFYUfucBZaryVksYEcMg3)\n\n2. **Test Credentials**:\n   - Username: fhirderrick / fhircamila\n   - Password: epicepic1\n\n3. **Test Flow**:\n   - Initiate connection\n   - Visit authorization URL\n   - Login with test credentials\n   - Authorize access\n   - Complete callback\n\n---\n\n## Security & Compliance\n\n### Data Protection\n\n1. **Encryption at Rest**\n   - OAuth tokens encrypted with AES-256-GCM\n   - Encryption key stored in environment variables\n   - Never log or expose tokens\n\n2. **Encryption in Transit**\n   - All API calls use HTTPS\n   - TLS 1.2 or higher required\n   - Certificate validation enforced\n\n3. **Token Management**\n   - Automatic token refresh\n   - Secure token storage\n   - Token expiration handling\n   - Revocation support\n\n### HIPAA Compliance\n\n1. **Access Controls**\n   - User authentication required\n   - Connection ownership verified\n   - Role-based access control\n\n2. **Audit Logging**\n   - All data access logged\n   - Sync operations tracked\n   - Connection changes recorded\n\n3. **Data Retention**\n   - Configurable retention policies\n   - Secure data deletion\n   - Backup and recovery\n\n4. **Business Associate Agreement (BAA)**\n   - Required with EHR providers\n   - Document data handling\n   - Incident response procedures\n\n### Best Practices\n\n1. **Token Security**\n   - Never expose tokens in logs\n   - Rotate encryption keys regularly\n   - Use secure random generation\n\n2. **Error Handling**\n   - Sanitize error messages\n   - No PHI in error logs\n   - Graceful degradation\n\n3. **Rate Limiting**\n   - Respect EHR rate limits\n   - Implement exponential backoff\n   - Queue sync operations\n\n4. **Monitoring**\n   - Track sync success rates\n   - Monitor token expiration\n   - Alert on failures\n\n---\n\n## Troubleshooting\n\n### Common Issues\n\n#### "Token expired and no refresh token available"\n\n**Solution**: User needs to re-authorize the connection.\n\n```typescript\n// Disconnect and reconnect\nawait EHRConnectionService.disconnectConnection(connectionId);\n// User must go through authorization flow again\n```\n\n#### "Failed to download document"\n\n**Possible causes**:\n- Document not available\n- Insufficient permissions\n- Network timeout\n\n**Solution**: Check document availability and retry.\n\n#### "Sync failed with 429 Too Many Requests"\n\n**Solution**: Implement rate limiting and exponential backoff.\n\n```typescript\n// Retry with exponential backoff\nconst delay = Math.pow(2, retryCount) * 1000;\nawait new Promise(resolve => setTimeout(resolve, delay));\n```\n\n---\n\n## Future Enhancements\n\n1. **Additional Providers**\n   - MEDITECH\n   - Practice Fusion\n   - Greenway Health\n\n2. **Advanced Features**\n   - Real-time notifications\n   - Webhook support\n   - Bulk data export (FHIR Bulk Data)\n\n3. **Analytics**\n   - Health timeline visualization\n   - Trend analysis\n   - Predictive insights\n\n4. **Integration**\n   - HL7 v2 support\n   - Direct messaging\n   - CDS Hooks\n\n---\n\n## Support\n\nFor questions or issues:\n- **Documentation**: `/docs/EHR_INTEGRATION.md`\n- **API Reference**: See above\n- **Epic Support**: https://fhir.epic.com/\n- **SMART on FHIR**: http://docs.smarthealthit.org/\n\n---\n\n**Last Updated**: January 2025  \n**Version**: 1.0.0  \n**Status**: Phase 1 Complete\n</create-file>\n</function_calls>'}